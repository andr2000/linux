From 1e2a43bff9f51f7fff84e7add45f6525d37327eb Mon Sep 17 00:00:00 2001
From: Oleksandr Andrushchenko <oleksandr_andrushchenko@epam.com>
Date: Mon, 14 May 2018 09:14:44 +0300
Subject: [PATCH v3 0/6] ALSA: xen-front: Add Xen para-virtualized frontend driver

Please note: this patch series depends on [3].

This patch series adds support for Xen [1] para-virtualized
sound frontend driver. It implements the protocol from
include/xen/interface/io/sndif.h with the following limitations:
- mute/unmute is not supported
- get/set volume is not supported
Volume control is not supported for the reason that most of the
use-cases (at the moment) are based on scenarious where
unprivileged OS (e.g. Android, AGL etc) use software mixers.

Both capture and playback are supported.

Corresponding backend, implemented as a user-space application, can be
found at [2].

Thank you,
Oleksandr

Changes since v2:
*****************

1. Kconfig: select SND_PCM instead of depends
2. Changed spinlock to mutex for protecting the rings since
   all the interrupts are threaded. Make those per event channel,
   not a single global one. This also addresses Juergen's comment
   on calling xen_snd_front_alsa_handle_cur_pos.
3. Fixed page leak on error while allocating an event channel
4. Fixed comments to start from a capital letter
5. Performed XEN_PAGE_SIZE != PAGE_SIZE check after xen_domain
   and xen_has_pv_devices checks
6. Changed driver specific structures names not to mislead with ALSA
   structs
7. Added comments on ring counters and overflows
8. Added MAINTAINERS entry

Changes since v1:
*****************

1. Moved driver from sound/drivers to sound/xen

2. Coding style changes to better meet Linux Kernel

3. Added explicit back and front synchronization
   In order to provide explicit synchronization between backend and
   frontend the following changes are introduced in the protocol:
    - add new ring buffer for sending asynchronous events from
      backend to frontend to report number of bytes played by the
      frontend (XENSND_EVT_CUR_POS)
    - introduce trigger events for playback control: start/stop/pause/resume
    - add "req-" prefix to event-channel and ring-ref to unify naming
      of the Xen event channels for requests and events

4. Added explicit back and front parameter negotiation
   In order to provide explicit stream parameter negotiation between
   backend and frontend the following changes are introduced in the protocol:
   add XENSND_OP_HW_PARAM_QUERY request to read/update
   configuration space for the parameters given: request passes
   desired parameter's intervals/masks and the response to this request
   returns allowed min/max intervals/masks to be used.

[1] https://xenproject.org/
[2] https://github.com/xen-troops/snd_be
[3] https://lkml.org/lkml/2018/4/12/522

Oleksandr Andrushchenko (6):
  ALSA: xen-front: Introduce Xen para-virtualized sound frontend driver
  ALSA: xen-front: Read sound driver configuration from Xen store
  ALSA: xen-front: Implement Xen event channel handling
  ALSA: xen-front: Implement handling of shared buffers
  ALSA: xen-front: Implement ALSA virtual sound driver
  MAINTAINERS: Add ALSA: xen-front: maintainer entry

 MAINTAINERS                       |   7 +
 sound/Kconfig                     |   2 +
 sound/Makefile                    |   2 +-
 sound/xen/Kconfig                 |  10 +
 sound/xen/Makefile                |   9 +
 sound/xen/xen_snd_front.c         | 397 +++++++++++++++
 sound/xen/xen_snd_front.h         |  54 ++
 sound/xen/xen_snd_front_alsa.c    | 821 ++++++++++++++++++++++++++++++
 sound/xen/xen_snd_front_alsa.h    |  23 +
 sound/xen/xen_snd_front_cfg.c     | 517 +++++++++++++++++++
 sound/xen/xen_snd_front_cfg.h     |  46 ++
 sound/xen/xen_snd_front_evtchnl.c | 496 ++++++++++++++++++
 sound/xen/xen_snd_front_evtchnl.h |  95 ++++
 sound/xen/xen_snd_front_shbuf.c   | 193 +++++++
 sound/xen/xen_snd_front_shbuf.h   |  36 ++
 15 files changed, 2707 insertions(+), 1 deletion(-)
 create mode 100644 sound/xen/Kconfig
 create mode 100644 sound/xen/Makefile
 create mode 100644 sound/xen/xen_snd_front.c
 create mode 100644 sound/xen/xen_snd_front.h
 create mode 100644 sound/xen/xen_snd_front_alsa.c
 create mode 100644 sound/xen/xen_snd_front_alsa.h
 create mode 100644 sound/xen/xen_snd_front_cfg.c
 create mode 100644 sound/xen/xen_snd_front_cfg.h
 create mode 100644 sound/xen/xen_snd_front_evtchnl.c
 create mode 100644 sound/xen/xen_snd_front_evtchnl.h
 create mode 100644 sound/xen/xen_snd_front_shbuf.c
 create mode 100644 sound/xen/xen_snd_front_shbuf.h

-- 
2.17.0

